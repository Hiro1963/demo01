<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Touch Enikki Ver.0155</title>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="viewport" content="width=device-width, user-scalable=no">
	<link rel="stylesheet" href="css/base.css" />
	<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
	<script>
	var stage
	var DyShpWhen = [];
	var DyShpWhere = [];
	var DyShpWho = [];
	var DyShpWhat = [];
	var DyShpDraw = [];
	var DyShpRectWord = [];
	var DyArrShp5wPos = [];
	var DyBackGround = [];
	var DyMvShape
	var MoveStarted = false;
	var text1
	var btn1,btn2,btn3,btn4,btn5
	var BtnColor = ["#ffffff","#0275d8","#d9534f","#5cb85c","#ff00ff","#0275d8","#808080"];
	var DyRectShape
	var DyBg_no
	var DyCurTypeNames

	var TypeNames = [
		'TYPE_DUMMY',
		'TYPE_WHERE',
		'TYPE_WHEN',
		'TYPE_WHO',
		'TYPE_WHAT',
		'TYPE_WRITE',
		'TYPE_CLEAR'
	];

	var DayNames = [
		'Sun',
		'Mon',
		'Tue',
		'Wed',
		'Thu',
		'Fri',
		'Sat'
	];

	var MonthNames = [
		'Jan',
		'Feb',
		'Mar',
		'Apr',
		'May',
		'Jun',
		'Jul',
		'Aug',
		'Sep',
		'Oct',
		'Nov',
		'Dec',
	];




	window.addEventListener("load", main);

	function main() {

		// 読み込みが終わってから初期化
		init();
		DyWord();
		DyButton();
		DyShapeDef();
		DyCreateRect();
		
		// 最下位に起動画面作成
		stage.addChildAt(DyBackGround[0],0);
		DyBackGround[0].x = 0;
		DyBackGround[0].y = 40;

		stage.addChildAt(DyBackGround[1],0);
		DyBackGround[1].x = 0;
		DyBackGround[1].y = 312;

	}

	function init() {

		// ステージを作成
		stage = new createjs.Stage("myCanvas");

		// タッチ操作をサポートしているブラウザーならば
		if (createjs.Touch.isSupported() == true) {
			// タッチ操作を有効にします。
			createjs.Touch.enable(stage)
		}
		stage.enableMouseOver();

		// 絵日記の文字を作成
		text1 = new createjs.Text("init", "24px serif", "DarkRed");
		stage.addChild(text1);

		// 選択肢の位置情報
		DyArrShp5wPos.push(new DyShp5wPos(15, 325));
		DyArrShp5wPos.push(new DyShp5wPos(100, 325));
		DyArrShp5wPos.push(new DyShp5wPos(185, 325));

	}

	function DyWord() {

		// tick イベントを登録する
		createjs.Ticker.addEventListener("tick", handleTick);

		function handleTick(event) {

			while (true) {
				if (true == MoveStarted) {

					// シェイプをマウスに追随させる
					if (stage.mouseY < 50) {
						break;
					}

					if ((stage.mouseY > 225)&&(DyCurTypeNames != DyMvShape.name.split(',')[0])) {
						break;
					}

					DyMvShape.x = stage.mouseX;
					DyMvShape.y = stage.mouseY;
				}
				break;
			}
			
			// 画面を更新する
			stage.update();
		}
	}

	function DyShp5wPos(x, y) {

		this.x = x;
		this.y = y;
	}

	function DyShapeRst() {

		//WHEN
		for (var i=0; i<DyShpWhen.length; i++) {
			DyShpWhen[i].x = DyArrShp5wPos[i].x;
			DyShpWhen[i].y = DyArrShp5wPos[i].y;
		}

		//WHERE
		for (var i=0; i<DyShpWhere.length; i++) {
			DyShpWhere[i].x = DyArrShp5wPos[i].x;
			DyShpWhere[i].y = DyArrShp5wPos[i].y;
		}

		//WHO
		for (var i=0; i<DyShpWho.length; i++) {
			DyShpWho[i].x = DyArrShp5wPos[i].x;
			DyShpWho[i].y = DyArrShp5wPos[i].y;
		}

		//WHAT
		for (var i=0; i<DyShpWhat.length; i++) {
			DyShpWhat[i].x = DyArrShp5wPos[i].x;
			DyShpWhat[i].y = DyArrShp5wPos[i].y;
		}

	}

	function DyBmpAdd(BmpType, BmpName, BmpWord) {

		// オブジェクト(WHEN)の作成
		var Dyshape = new createjs.Bitmap(BmpName);
		Dyshape.name = BmpWord;
		
		switch( BmpType ) {
			case 'TYPE_WHEN':
				DyShpWhen.push(Dyshape);
				break;
			case 'TYPE_WHERE':
				DyShpWhere.push(Dyshape);
				break;
			case 'TYPE_WHO':
				DyShpWho.push(Dyshape);
				break;
			case 'TYPE_WHAT':
				DyShpWhat.push(Dyshape);
				break;
		}
	}

	function DyShapeDef() {
		// オブジェクト(WHEN)の作成
		DyBackGround.push(new createjs.Bitmap("boot1.png"));
		DyBackGround.push(new createjs.Bitmap("boot2.png"));
		DyBackGround.push(new createjs.Bitmap("sea1.png"));
		DyBackGround.push(new createjs.Bitmap("park1.png"));

		DyBmpAdd("TYPE_WHEN", "when1.png", "TYPE_WHEN,in the morning");
		DyBmpAdd("TYPE_WHEN", "when2.png", "TYPE_WHEN,in the afternoon");

		DyBmpAdd("TYPE_WHERE", "where1.png", "TYPE_WHERE,at the sea,2");
		DyBmpAdd("TYPE_WHERE", "where2.png", "TYPE_WHERE,in the park,3");

		DyBmpAdd("TYPE_WHO", "who0.png", "TYPE_WHO,,0");
		DyBmpAdd("TYPE_WHO", "who1.png", "TYPE_WHO,with my friend,1");
		DyBmpAdd("TYPE_WHO", "who2.png", "TYPE_WHO,with my friend,2");

		DyBmpAdd("TYPE_WHAT", "what1.png", "TYPE_WHAT,enjoyed the beach ball");
		DyBmpAdd("TYPE_WHAT", "what2.png", "TYPE_WHAT,enjoyed the swing");
		DyShapeRst();

		// イベントを登録
		
		//WHEN
		for (var i=0; i<DyShpWhen.length; i++) {
			DyShpWhen[i].addEventListener("pressup", handlePressUp);
			DyShpWhen[i].addEventListener("pressmove", handlePressMove);
		}

		//WHERE
		for (var i=0; i<DyShpWhere.length; i++) {
			DyShpWhere[i].addEventListener("pressup", handlePressUp);
			DyShpWhere[i].addEventListener("pressmove", handlePressMove);
		}

		//WHO
		for (var i=0; i<DyShpWho.length; i++) {
			DyShpWho[i].addEventListener("pressup", handlePressUp);
			DyShpWho[i].addEventListener("pressmove", handlePressMove);
		}

		//WHAT
		for (var i=0; i<DyShpWhat.length; i++) {
			DyShpWhat[i].addEventListener("pressup", handlePressUp);
			DyShpWhat[i].addEventListener("pressmove", handlePressMove);
		}

		// イベントを登録
		function handlePressMove(event) {
//			text1.text = "PressMove";
			// 押した時の処理を記述
		    if (false == MoveStarted) {
				DyMvShape = event.target;
				
				if ((DyMvShape.y < 270)||('TYPE_WHO' == DyMvShape.name.split(',')[0])) {
						MoveStarted = true;
				}
				else {
					// 選択肢が絵にあれば動ない
					var i;
					for (i=0; i<DyShpDraw.length; i++) {
						if (DyShpDraw[i].name.split(',')[0] == DyMvShape.name.split(',')[0]) {
							break;
						}
					}
					if (i == DyShpDraw.length) {
						MoveStarted = true;
					}
				}
			}
		}

		function handlePressUp(event) {
//			text1.text = "PressUP";
 			// クリックされた時の処理を記述
		    if (true == MoveStarted) {
				MoveStarted = false;
		        // 絵にあるか？
				if (DyMvShape.y < 270 ) {
					for (var i=0; i<DyShpDraw.length; i++) {
						if(DyShpDraw[i].name == DyMvShape.name) {
							break;
						}
					}
					if (i == DyShpDraw.length) {
						var words = DyMvShape.name.split(',');
						DyShpDraw.push(DyMvShape);
						if('TYPE_WHERE' == words[0]) {
							stage.addChildAt(DyBackGround[Number(words[2])],0);
							DyBackGround[Number(words[2])].x = 0;
							DyBackGround[Number(words[2])].y = 40;
							DyBg_no = words[2];
							//自分を追加
							DyShpWho[0].x = 100;
							DyShpWho[0].y = 50;
							DyShpDraw.push(DyShpWho[0]);
							stage.addChild(DyShpWho[0]);
						}
					}
				}
				else {
					for (var i=0; i<DyShpDraw.length; i++) {
						if(DyShpDraw[i].name == DyMvShape.name) {
							DyShpDraw.splice(i, 1);
							break;
						}
					}
					var words = DyMvShape.name.split(',');
					if('TYPE_WHERE' == words[0]) {
						stage.removeChild(DyBackGround[DyBg_no]);
					}

				}
			}
		}
    }

	function DyObjClearAll() {

		DyShpDraw.length = 0;
	}

	function DyObjClear5W() {

		stage.removeChild(text1);
//		stage.removeChild(DyBackGround[DyBg_no]);

		//WHEN
		for (var i=0; i<DyShpWhen.length; i++) {
			// 絵にあるものは残す
			for (var j=0; j<DyShpDraw.length; j++) {
				if (DyShpWhen[i].name == DyShpDraw[j].name) {
					break;
			    }
			}
			if (j == DyShpDraw.length) {
				stage.removeChild(DyShpWhen[i]);
			}
		}

		//WHERE
		for (var i=0; i<DyShpWhere.length; i++) {
			// 選択肢から絵にあるものは残す
			for (var j=0; j<DyShpDraw.length; j++) {
				if(DyShpWhere[i].name == DyShpDraw[j].name) {
					break;
				}
			}
			if (j == DyShpDraw.length) {
				stage.removeChild(DyShpWhere[i]);
			}
		}

		//WHO
		for (var i=0; i<DyShpWho.length; i++) {
			// 選択肢から絵にあるものは残す
			for (var j=0; j<DyShpDraw.length; j++) {
				if(DyShpWho[i].name == DyShpDraw[j].name) {
					break;
				}
			}
			if (j == DyShpDraw.length) {
				stage.removeChild(DyShpWho[i]);
			}
		}

		//WHAT
		for (var i=0; i<DyShpWhat.length; i++) {
			// 選択肢から絵にあるものは残す
			for (var j=0; j<DyShpDraw.length; j++) {
				if(DyShpWhat[i].name == DyShpDraw[j].name) {
					break;
				}
			}
			if (j == DyShpDraw.length) {
				stage.removeChild(DyShpWhat[i]);
			}
		}
	}

	function DyButton() {

		// ボタンを作成
		btn1 = createButton("WHERE", 93, 40, BtnColor[1]);
		btn1.x = 0;
		btn1.y = 270;
		stage.addChild(btn1);

		btn2 = createButton("WHEN", 93, 40, BtnColor[2]);
		btn2.x = 93.75;
		btn2.y = 270;
		stage.addChild(btn2);

		btn3 = createButton("WHO", 93, 40, BtnColor[3]);
		btn3.x = 187.5;
		btn3.y = 270;
		stage.addChild(btn3);

		btn4 = createButton("WHAT", 93, 40, BtnColor[4]);
		btn4.x = 281.25;
		btn4.y = 270;
		stage.addChild(btn4);

		// ボタンを作成
		btn5 = createButton("WRITE", 282, 40, BtnColor[5]);
		btn5.x = 0;
		btn5.y = 0;
		stage.addChild(btn5);

		// ボタンを作成
		btn6 = createButton("CLEAR", 91, 40, BtnColor[6]);
		btn6.x = 283;
		btn6.y = 0;
		stage.addChild(btn6);

		// イベントを登録
		btn1.addEventListener("click", handleClick1);
		btn2.addEventListener("click", handleClick2);
		btn3.addEventListener("click", handleClick3);
		btn4.addEventListener("click", handleClick4);
		btn5.addEventListener("click", handleClick5);
		btn6.addEventListener("click", handleClick6);

		//WHERE
		function handleClick1(event) {
			// クリックされた時の処理を記述
			DyCurTypeNames = TypeNames[1];
			DySwBtn(1);
			DyObjClear5W();
			DyDrawRect(1);
			for (var i=0; i<DyShpWhere.length; i++) {
				stage.addChild(DyShpWhere[i]);
			}
		}

		//WHEN
		function handleClick2(event) {
			// クリックされた時の処理を記述
			DyCurTypeNames = TypeNames[2];
			DySwBtn(2);
			DyObjClear5W();
			DyDrawRect(2);
			for (var i=0; i<DyShpWhen.length; i++) {
				stage.addChild(DyShpWhen[i]);
			}
		}

		//WHO
		function handleClick3(event) {
			// クリックされた時の処理を記述
			DyCurTypeNames = TypeNames[3];
			DySwBtn(3);
			DyObjClear5W();
			DyDrawRect(3);
			for (var i=0; i<DyShpWho.length; i++) {
				stage.addChild(DyShpWho[i]);
			}
		}

		//WHAT
		function handleClick4(event) {
			// クリックされた時の処理を記述
			DyCurTypeNames = TypeNames[4];
			DySwBtn(4);
			DyObjClear5W();
			DyDrawRect(4);
			for (var i=0; i<DyShpWhat.length; i++) {
				stage.addChild(DyShpWhat[i]);
			}
		}

		//WRITE
		function handleClick5(event) {
			// クリックされた時の処理を記述
			DyCurTypeNames = TypeNames[5];
			DySwBtn(5);
			DyObjClear5W();
			DyDrawRect(5);
			DyWrite();
		}

		//CLEAR
		function handleClick6(event) {
			// クリックされた時の処理を記述
			DyCurTypeNames = TypeNames[6];
			window.location.reload();
		}

//		function handleClick7(event) {
//			// クリックされた時の処理を記述
//			DyCurTypeNames = TypeNames[5];
//			DySwBtn(6);
//			DyShapeRst();
//			DyObjClearAll();
//			DyObjClear5W();
//			DyDrawRect(0);
//			stage.removeChild(DyBackGround[DyBg_no]);
//
//		}

	}

	function strIns(str, idx, val){
		  var res = str.slice(0, idx) + val + str.slice(idx);
		  return res;
	}

	function DyWrite() {

		//日記を書く
		var words = [];

//		if (DyShpDraw.length == 0) {
//			return;
//		}

//		//絵日記を読み取る
//		for(var i=0;i<DyShpDraw.length; ++i) {
//			words[i] = DyShpDraw[i].name.split(',');
//		}

		//絵日記を読み取る
		var fgWhat = 0;
		var fgWho = 0;
		var fgWhen = 0;
		var fgWhere = 0;
		for(var i=0;i<DyShpDraw.length; ++i) {
			words[i] = DyShpDraw[i].name.split(',');
			if( 'TYPE_WHAT' == words[i][0] ) {
				var fgWhat = 1;
			}
			if( 'TYPE_WHO' == words[i][0] ) {
				var fgWho = 1;
			}
			if( 'TYPE_WHEN' == words[i][0] ) {
				var fgWhen = 1;
			}
			if( 'TYPE_WHERE' == words[i][0] ) {
				var fgWhere = 1;
			}
		}

		text1.x = 50;
		text1.y = 400;
		text1.color = "red"
		if (0 == fgWhere) {
			text1.text = "Please select item [WHERE].\n"
			stage.addChild(text1);
			return;
		}
		if (0 == fgWhen) {
			text1.text = "Please select item [WHEN].\n"
			stage.addChild(text1);
			return;
		}
		if (0 == fgWho) {
			text1.text = "Please select item [WHO].\n"
			stage.addChild(text1);
			return;
		}
		if (0 == fgWhat) {
			text1.text = "Please select item [WHAT].\n"
			stage.addChild(text1);
			return;
		}

		var now = new Date();
		strText1 =  MonthNames[now.getMonth()] + ' ';
		strText1 += String(now.getDate()) + ',';
		strText1 += ' ' + String(now.getFullYear());
		strText1 += '(' + DayNames[now.getDay()] + '.)';
		strText1 += '\n\n';
		
		var wLen1 = strText1.length;

		var strText2 = "I";

		for (var i=0; i<words.length; i++) {
			if( 'TYPE_WHAT' == words[i][0] ) {
				strText2 += " ";
				strText2 += words[i][1];
			}
		}
		for (var i=0; i<words.length; i++) {
			if( 'TYPE_WHO' == words[i][0] ) {
				if (0 != words[i][2]) {
					strText2 += " ";
				}

				//フレンドのときは一人でも二人でもフレンドにしたい
				var j
				for (j=0; j<i; j++) {
					if (words[i][1] == words[j][1]) {
						break;
					}
				}
				
				if (j == i ) {
					strText2 += words[i][1];
				}
			}
		}
		for (var i=0; i<words.length; i++) {
			if( 'TYPE_WHERE' == words[i][0] ) {
				strText2 += " ";
				strText2 += words[i][1];
			}
		}
		for (var i=0; i<words.length; i++) {
			if( 'TYPE_WHEN' == words[i][0] ) {
				strText2 += " ";
				strText2 += words[i][1];
			}
		}

		var wBus;
		var wLen2 = strText2.length;
		wBus = Math.floor(wLen2 / 35);

		var wStr = strText2;
		for (var i=0; i<wBus; i++) {
//			var idx = (i+1)*35+1;
			var idx = (i+1)*35;
			var res1 = wStr.slice(idx-1,idx+1);
			var res2 = wStr.slice(30,40);
			var res3 = wStr.slice(idx-1,idx-1);
			if (wStr.slice(idx-1,idx) == " ") {
				wStr = strIns(wStr, (i+1)*35, '\n');
			}
			else {
				wStr = strIns(wStr, (i+1)*35, '-\n');
			}
		}
		strText2 = wStr;

		text1.text = strText1 + strText2 + ".\n";
		text1.x = 10;
		text1.y = 325;
		text1.color = "DarkRed"
		stage.addChild(text1);
	}


	function DySwBtn(BtnNo) {

		//起動画面を消す
		stage.removeChild(DyBackGround[0]);

		if (1 != BtnNo) {
			btn1.getChildAt(0).visible = true;
			btn1.getChildAt(1).visible = false;
			btn1.getChildAt(2).color = BtnColor[1];
		}

		if (2 != BtnNo) {
			btn2.getChildAt(0).visible = true;
			btn2.getChildAt(1).visible = false;
			btn2.getChildAt(2).color = BtnColor[2];
		}

		if (3 != BtnNo) {
			btn3.getChildAt(0).visible = true;
			btn3.getChildAt(1).visible = false;
			btn3.getChildAt(2).color = BtnColor[3];
		}

		if (4 != BtnNo) {
			btn4.getChildAt(0).visible = true;
			btn4.getChildAt(1).visible = false;
			btn4.getChildAt(2).color = BtnColor[4];
		}

		if (5 != BtnNo) {
			btn5.getChildAt(0).visible = true;
			btn5.getChildAt(1).visible = false;
			btn5.getChildAt(2).color = BtnColor[5];
		}

		if (6 != BtnNo) {
			btn6.getChildAt(0).visible = true;
			btn6.getChildAt(1).visible = false;
			btn6.getChildAt(2).color = BtnColor[6];
		}
	}

	/**
	 * CreateJSのボタンを作成する関数です。
	 * この関数でボタンを作ったらステージに追加したり、クリックイベントを登録しましょう。
	 * @param {String} text ボタンのラベル文言です。
	 * @param {Number} width ボタンの横幅(単位はpx)です。
	 * @param {Number} height ボタンの高さ(単位はpx)です。
	 * @param {String} keyColor ボタンのキーカラーです。
	 * @returns {createjs.Container} ボタンの参照を返します。
	 */
	function createButton(text, width, height, keyColor) {

	  // ボタン要素をグループ化
	  var button = new createjs.Container();
	  button.name = text; // ボタンに参考までに名称を入れておく(必須ではない)
	  button.cursor = "pointer"; // ホバー時にカーソルを変更する

	  // 通常時の座布団を作成
	  var bgUp = new createjs.Shape();
	  bgUp.graphics
	          .setStrokeStyle(1.0)
	          .beginStroke(keyColor)
	          .beginFill("white")
	          .drawRoundRect(0.5, 0.5, width - 1.0, height - 1.0, 4);
	  button.addChild(bgUp);
	  bgUp.visible = true; // 表示する

	  // ロールオーバー時の座布団を作成
	  var bgOver = new createjs.Shape();
	  bgOver.graphics
	          .beginFill(keyColor)
	          .drawRoundRect(0, 0, width, height, 4);
	  bgOver.visible = false; // 非表示にする
	  button.addChild(bgOver);

	  // ラベルを作成
	  var label = new createjs.Text(text, "18px sans-serif", keyColor);
	  label.x = width / 2;
	  label.y = height / 2;
	  label.textAlign = "center";
	  label.textBaseline = "middle";
	  button.addChild(label);

	  // ロールオーバーイベントを登録
//	  button.addEventListener("mouseover", handleMouseOver);
//	  button.addEventListener("mouseout", handleMouseOut);
	  button.addEventListener("pressup", handlePressUp);
	  button.addEventListener("pressmove", handlePressMove);
	  function handlePressUp(event) {
//		text1.text = "pressup";
	    bgUp.visible = false;
	    bgOver.visible = true;
	    label.color = "white";
	  }

	  function handlePressMove(event) {
//		text1.text = "pressmove";
	    bgUp.visible = true;
	    bgOver.visible = false;
	    label.color = keyColor;
	  }

	  return button;
	}

function DyDrawRect(BtnNo) {

	// 選択肢の枠を切り替える
	for (var i=0; i < DyShpRectWord.length; i++) {
		stage.removeChild(DyShpRectWord[i]);
	}

	for (var i=0; i < DyShpRectWord.length; i++) {
		if (i == BtnNo-1) {
			stage.addChild(DyShpRectWord[i]);
		}
		else {
			stage.removeChild(DyShpRectWord[i]);
		}
	}
}

function DyCreateRect() {

	for (var i=1; i<=6; i++) {
		//Graphicsオブジェクトを作成する
		var g = new createjs.Graphics();
		//線の色を指定
		g.beginStroke(BtnColor[i]);
		//塗りつぶしの色を作成
		g.beginFill("#ffffcc");
		// 線の幅を指定
		g.setStrokeStyle(6);
//		g.setStrokeStyle(10);
		//四角を描く(x:0,y:0を左上角とした幅100px,高さ100pxの四角)
//		g.drawRoundRect(2,313,372,238,30);
		g.drawRoundRect(2,312,372,238,30);
		//Displayオブジェクトを作成
		DyShpRectWord.push(new createjs.Shape(g));
	}
}



</script>
</head>
<body>
  <canvas id="myCanvas" width="375" height="560"></canvas>
</body>
</html>